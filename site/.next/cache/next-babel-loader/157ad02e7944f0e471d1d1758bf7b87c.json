{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _taggedTemplateLiteral from \"@babel/runtime-corejs2/helpers/esm/taggedTemplateLiteral\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nvar _jsxFileName = \"C:\\\\Users\\\\wojtalam\\\\Workspace\\\\Github\\\\arc-keystone5\\\\site\\\\lib\\\\authetication.js\";\nvar __jsx = React.createElement;\n\nfunction _templateObject3() {\n  var data = _taggedTemplateLiteral([\"\\n          mutation {\\n            unauthenticateUser {\\n              success\\n            }\\n          }\\n        \"]);\n\n  _templateObject3 = function _templateObject3() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject2() {\n  var data = _taggedTemplateLiteral([\"\\n          mutation signin($email: String, $password: String) {\\n            authenticateUserWithPassword(email: $email, password: $password) {\\n              item {\\n                \", \"\\n              }\\n            }\\n          }\\n        \"]);\n\n  _templateObject2 = function _templateObject2() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteral([\"\\n          query {\\n            authenticatedUser {\\n              \", \"\\n            }\\n          }\\n        \"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nimport React, { Component, createContext, useContext } from 'react';\nimport { withApollo } from 'react-apollo';\nimport gql from 'graphql-tag';\n/**\n * AuthContext\n * -----------\n * This is the base react context instance. It should not be used\n * directly but is exported here to simplify testing.\n */\n\nexport var AuthContext = createContext();\n/**\n * useAuth\n * -------\n * A hook which provides access to the AuthContext\n */\n\nexport var useAuth = function useAuth() {\n  return useContext(AuthContext);\n};\nvar userFragment = \"\\n  id\\n\";\n/**\n * AuthProvider\n * ------------\n * AuthProvider is a component which keeps track of the user's\n * authenticated state and provides methods for managing the auth state.\n */\n\nvar AuthProviderClass =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(AuthProviderClass, _Component);\n\n  function AuthProviderClass(props) {\n    var _this;\n\n    _classCallCheck(this, AuthProviderClass);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(AuthProviderClass).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"setUserData\", function (user) {\n      _this.setState({\n        isInitialising: false,\n        isLoading: false,\n        isAuthenticated: !!user,\n        user: user\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"checkSession\",\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee() {\n      var isLoading;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              // Avoid an extra re-render\n              isLoading = _this.state.isLoading;\n\n              if (!isLoading) {\n                _this.setState({\n                  isLoading: true\n                });\n              }\n\n              return _context.abrupt(\"return\", _this.props.client.query({\n                query: gql(_templateObject(), userFragment),\n                fetchPolicy: 'no-cache'\n              }).then(function (_ref2) {\n                var authenticatedUser = _ref2.data.authenticatedUser,\n                    error = _ref2.error;\n\n                if (error) {\n                  throw error;\n                }\n\n                _this.setUserData(authenticatedUser);\n              })[\"catch\"](function (error) {\n                console.error(error);\n\n                _this.setState({\n                  error: error,\n                  isLoading: false\n                });\n\n                throw error;\n              }));\n\n            case 3:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"signin\",\n    /*#__PURE__*/\n    function () {\n      var _ref4 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(_ref3) {\n        var email, password;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                email = _ref3.email, password = _ref3.password;\n\n                _this.setState({\n                  error: null,\n                  isLoading: true\n                }); // NOTE: We are not capturing the `token` here on purpose; The GraphQL API\n                // will set a `keystone.sid` cookie on its domain, which will be\n                // automatically read for each subsequent query.\n\n\n                return _context3.abrupt(\"return\", _this.props.client.mutate({\n                  mutation: gql(_templateObject2(), userFragment),\n                  fetchPolicy: 'no-cache',\n                  variables: {\n                    email: email,\n                    password: password\n                  }\n                }).then(\n                /*#__PURE__*/\n                function () {\n                  var _ref6 = _asyncToGenerator(\n                  /*#__PURE__*/\n                  _regeneratorRuntime.mark(function _callee2(_ref5) {\n                    var authenticateUserWithPassword, error;\n                    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                      while (1) {\n                        switch (_context2.prev = _context2.next) {\n                          case 0:\n                            authenticateUserWithPassword = _ref5.data.authenticateUserWithPassword, error = _ref5.error;\n\n                            if (!error) {\n                              _context2.next = 3;\n                              break;\n                            }\n\n                            throw error;\n\n                          case 3:\n                            _context2.next = 5;\n                            return _this.props.client.resetStore();\n\n                          case 5:\n                            if (authenticateUserWithPassword && authenticateUserWithPassword.item) {\n                              _this.setUserData(authenticateUserWithPassword.item);\n                            }\n\n                          case 6:\n                          case \"end\":\n                            return _context2.stop();\n                        }\n                      }\n                    }, _callee2);\n                  }));\n\n                  return function (_x2) {\n                    return _ref6.apply(this, arguments);\n                  };\n                }())[\"catch\"](function (error) {\n                  console.error(error);\n\n                  _this.setState({\n                    error: error,\n                    isLoading: false\n                  });\n\n                  throw error;\n                }));\n\n              case 3:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x) {\n        return _ref4.apply(this, arguments);\n      };\n    }());\n\n    _defineProperty(_assertThisInitialized(_this), \"signout\",\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee5() {\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _this.setState({\n                error: null,\n                isLoading: true\n              });\n\n              return _context5.abrupt(\"return\", _this.props.client.mutate({\n                mutation: gql(_templateObject3()),\n                fetchPolicy: 'no-cache'\n              }).then(\n              /*#__PURE__*/\n              function () {\n                var _ref9 = _asyncToGenerator(\n                /*#__PURE__*/\n                _regeneratorRuntime.mark(function _callee4(_ref8) {\n                  var unauthenticateUser, error;\n                  return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n                    while (1) {\n                      switch (_context4.prev = _context4.next) {\n                        case 0:\n                          unauthenticateUser = _ref8.data.unauthenticateUser, error = _ref8.error;\n\n                          if (!error) {\n                            _context4.next = 3;\n                            break;\n                          }\n\n                          throw error;\n\n                        case 3:\n                          _context4.next = 5;\n                          return _this.props.client.resetStore();\n\n                        case 5:\n                          if (unauthenticateUser && unauthenticateUser.success) {\n                            _this.setUserData(null);\n                          }\n\n                        case 6:\n                        case \"end\":\n                          return _context4.stop();\n                      }\n                    }\n                  }, _callee4);\n                }));\n\n                return function (_x3) {\n                  return _ref9.apply(this, arguments);\n                };\n              }())[\"catch\"](function (error) {\n                console.error(error);\n\n                _this.setState({\n                  error: error,\n                  isLoading: false\n                });\n\n                throw error;\n              }));\n\n            case 2:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    })));\n\n    _this.state = {\n      user: props.initialUserValue,\n      isLoading: true\n    };\n    return _this;\n  }\n\n  _createClass(AuthProviderClass, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.checkSession();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$state = this.state,\n          user = _this$state.user,\n          isLoading = _this$state.isLoading,\n          isAuthenticated = _this$state.isAuthenticated;\n      return __jsx(AuthContext.Provider, {\n        value: {\n          isAuthenticated: isAuthenticated,\n          isLoading: isLoading,\n          signin: this.signin,\n          signout: this.signout,\n          user: user\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 153\n        },\n        __self: this\n      }, this.props.children);\n    }\n  }]);\n\n  return AuthProviderClass;\n}(Component);\n\nexport var AuthProvider = withApollo(AuthProviderClass);","map":{"version":3,"sources":["C:/Users/wojtalam/Workspace/Github/arc-keystone5/site/lib/authetication.js"],"names":["React","Component","createContext","useContext","withApollo","gql","AuthContext","useAuth","userFragment","AuthProviderClass","props","user","setState","isInitialising","isLoading","isAuthenticated","state","client","query","fetchPolicy","then","authenticatedUser","data","error","setUserData","console","email","password","mutate","mutation","variables","authenticateUserWithPassword","resetStore","item","unauthenticateUser","success","initialUserValue","checkSession","signin","signout","children","AuthProvider"],"mappings":"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","sourcesContent":["import React, { Component, createContext, useContext } from 'react';\nimport { withApollo } from 'react-apollo';\nimport gql from 'graphql-tag';\n\n/**\n * AuthContext\n * -----------\n * This is the base react context instance. It should not be used\n * directly but is exported here to simplify testing.\n */\nexport const AuthContext = createContext();\n\n/**\n * useAuth\n * -------\n * A hook which provides access to the AuthContext\n */\nexport const useAuth = () => useContext(AuthContext);\n\nconst userFragment = `\n  id\n`;\n\n/**\n * AuthProvider\n * ------------\n * AuthProvider is a component which keeps track of the user's\n * authenticated state and provides methods for managing the auth state.\n */\nclass AuthProviderClass extends Component {\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      user: props.initialUserValue,\n      isLoading: true,\n    };\n  }\n\n  componentDidMount() {\n    this.checkSession();\n  }\n\n  setUserData = user => {\n    this.setState({\n      isInitialising: false,\n      isLoading: false,\n      isAuthenticated: !!user,\n      user,\n    });\n  };\n\n  checkSession = async () => {\n    // Avoid an extra re-render\n    const { isLoading } = this.state;\n    if (!isLoading) {\n      this.setState({ isLoading: true });\n    }\n\n    return this.props.client\n      .query({\n        query: gql`\n          query {\n            authenticatedUser {\n              ${userFragment}\n            }\n          }\n        `,\n        fetchPolicy: 'no-cache',\n      })\n      .then(({ data: { authenticatedUser }, error }) => {\n        if (error) {\n          throw error;\n        }\n        this.setUserData(authenticatedUser);\n      })\n      .catch(error => {\n        console.error(error);\n        this.setState({ error, isLoading: false });\n        throw error;\n      });\n  };\n\n  signin = async ({ email, password }) => {\n    this.setState({ error: null, isLoading: true });\n    // NOTE: We are not capturing the `token` here on purpose; The GraphQL API\n    // will set a `keystone.sid` cookie on its domain, which will be\n    // automatically read for each subsequent query.\n    return this.props.client\n      .mutate({\n        mutation: gql`\n          mutation signin($email: String, $password: String) {\n            authenticateUserWithPassword(email: $email, password: $password) {\n              item {\n                ${userFragment}\n              }\n            }\n          }\n        `,\n        fetchPolicy: 'no-cache',\n        variables: { email, password },\n      })\n      .then(async ({ data: { authenticateUserWithPassword }, error }) => {\n        if (error) {\n          throw error;\n        }\n        // Ensure there's no old unauthenticated data hanging around\n        await this.props.client.resetStore();\n        if (authenticateUserWithPassword && authenticateUserWithPassword.item) {\n          this.setUserData(authenticateUserWithPassword.item);\n        }\n      })\n      .catch(error => {\n        console.error(error);\n        this.setState({ error, isLoading: false });\n        throw error;\n      });\n  };\n\n  signout = async () => {\n    this.setState({ error: null, isLoading: true });\n    return this.props.client\n      .mutate({\n        mutation: gql`\n          mutation {\n            unauthenticateUser {\n              success\n            }\n          }\n        `,\n        fetchPolicy: 'no-cache',\n      })\n      .then(async ({ data: { unauthenticateUser }, error }) => {\n        if (error) {\n          throw error;\n        }\n        // Ensure there's no old authenticated data hanging around\n        await this.props.client.resetStore();\n        if (unauthenticateUser && unauthenticateUser.success) {\n          this.setUserData(null);\n        }\n      })\n      .catch(error => {\n        console.error(error);\n        this.setState({ error, isLoading: false });\n        throw error;\n      });\n  };\n\n  render() {\n    const { user, isLoading, isAuthenticated } = this.state;\n    return (\n      <AuthContext.Provider\n        value={{\n          isAuthenticated,\n          isLoading,\n          signin: this.signin,\n          signout: this.signout,\n          user,\n        }}\n      >\n        {this.props.children}\n      </AuthContext.Provider>\n    );\n  }\n}\n\nexport const AuthProvider = withApollo(AuthProviderClass);\n"]},"metadata":{},"sourceType":"module"}